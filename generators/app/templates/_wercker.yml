box: linode/lamp
build:
    steps:
    - script:
        name: Install Dependencies
        code: |
            sudo apt-get update -y
            sudo apt-get install -y build-essential curl wget git php5-curl unzip php5-mysql php5-gd
            wget -q https://deb.nodesource.com/setup_4.x
            chmod +x setup_4.x
            sudo ./setup_4.x
            rm setup_4.x
            sudo apt-get install nodejs -y
            npm install
            curl -sS https://getcomposer.org/installer | php
            sudo mv composer.phar /usr/bin/composer
            composer install --prefer-source --no-interaction
    - script:
        name: Setup Global Stuff
        code: |
            # Aquifer will fail unless Drush is installed globally.
            composer global require drush/drush:7.1.* --no-interaction
            # Configure Drush.
            sudo mkdir -p ~/.drush
            cp ./wercker/<%= appName %>.aliases.drushrc.php ~/.drush
            sudo ln -s ~/.composer/vendor/bin/drush /usr/bin/drush
            # Drupal settings.
            cp ./wercker/settings.secret.php ./settings
            # Configure Solr.
            #cp -R /opt/solr-4.3.1 $HOME/solr
            #curl http://ftp.drupal.org/files/projects/apachesolr-7.x-1.x-dev.tar.gz | tar -xz
            #cp -r apachesolr/solr-conf/solr-4.x/* $HOME/solr/example/solr/collection1/conf
            #cd $HOME/solr/example/; java -jar start.jar >> $HOME/solr.log:
            # Install and start Selenium.
            #wget http://selenium-release.storage.googleapis.com/2.48/selenium-server-standalone-2.48.2.jar
            #java -jar selenium-server-standalone-2.48.2.jar:
            # Configure Apache.
            cp ./wercker/<%= appName %>.dev.conf /etc/apache2/sites-available/
            sudo a2ensite <%= appName %>.dev
            sudo a2enmod rewrite
            sudo service apache2 restart
            # Edit hosts file.
            sudo echo "127.0.0.1 <%= appName %>.dev" >> /etc/hosts

            # Prepare Drupal Installation and Install it.
            # Build the Drupal site and set files permissions.
            ./node_modules/.bin/aquifer build
            ./node_modules/.bin/aquifer extensions-load
            sudo chown -R www-data:www-data ./build/sites/default/files
            # Set alias.
            drush site-set @<%= appName %>.<%= appName %>.dev
            drush cc drush
            # Start mysql and apache servers.
            sudo service apache2 start
            sudo service mysql start
            # Create Drupal DB
            mysql -u root -pAdmin2015 -e "create database drupal;"
            # Install Drupal and disable sendmail.
            /usr/bin/env PHP_OPTIONS="-d sendmail_path=`which true`" drush si -y <%= appName %>
            # Post build configuration.
            drush cc drush
            drush master-set-current-scope local
            drush master-execute -y
            drush cc all

    - script:
        name: Test all the things!
        code: |
            # PHP Lint.
            ./node_modules/.bin/gulp phplint
            # Drupal Coding Standards.
            ./node_modules/.bin/gulp drupalcs
            # ESLint.
            ./node_modules/.bin/gulp eslint
            # Overridden features.
            drush @<%= appName %>.<%= appName %>.dev fl | grep -qi 'overridden' && (echo 'Overridden Features FAIL' && exit 1) || (echo 'Overridden Features PASS' && exit 0)
            # Available updates.
            drush @<%= appName %>.<%= appName %>.dev ups | grep -qi "update available" && (echo 'Updates available FAIL' && exit 1) || (echo 'No updates available PASS' && exit 0)
            # Debug
            ls /pipeline/source/build
            # Start drush builtin server.
            drush runserver --server=builtin 8082 --strict=0 &
            sleep 10
            # Behat tests.
            ./vendor/bin/behat -p wercker
deploy:
    steps:
    - script:
        name: Deploy to pantheon
        code: |
            ./node_modules/.bin/aquifer deploy-git -m "Auto deploy commit message"
